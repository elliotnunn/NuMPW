
; File: ATalkEqu.a
;
; Version 1.0
;
; Copyright Apple Computer, Inc. 1984, 1985, 1986
; All Rights Reserved
;

; AppleTalk Equates - This file defines the low-level equates for the
; AppleTalk drivers.

; System global locations used

AbusVars		EQU  $2D8	 ; Pointer to the local variables
AbusDCE 		EQU  $2DC	 ; Pointer to the DCE

atpLoadedBit	EQU  4	 ; Bit number for ATP loaded in PortBUse

; AppleTalk unit numbers

mppUnitNum		EQU  9	 ; MPP unit number
atpUnitNum		EQU  10  ; ATP unit number


;+ Name Binding Protocol (NBP)

NBP 			EQU  $02	 ; DDP protocol type code for NBP

nbpControl		EQU  0	 ; Control code
nbpTCount		EQU  0	 ; Tuple count
nbpID			EQU  1	 ; NBP ID
nbpTuple		EQU  2	 ; Start of the first tuple

;NBP tuple header offsets:

TupleNet		EQU  0	 ; Offset to network no. [word]
TupleNode		EQU  2	 ; Offset to node ID [byte]
TupleSkt		EQU  3	 ; Offset to socket number [byte]
TupleEnum		EQU  4	 ; Offset to enumerator [byte]
TupleName		EQU  5	 ; Offset to name part of tuple [byte]
TupleAddrSz 	EQU  5	 ; tuple address field size

; NBP control codes - the following define the different types of NBP packets:

BrRq			EQU  1	 ; Broadcast request
LkUp			EQU  2	 ; Lookup request
LkUpReply		EQU  3	 ; Lookup reply

; NBP miscellaneous

NIS 			EQU  2	 ; Names Information Socket (NIS) number
TupleMax		EQU  15  ; Most tuples in a lookup reply
Equals			EQU  '='	 ; Wildcard symbol
Star			EQU  '*'	 ; "This zone" symbol


;+ Routing Table Maintenance Protocol (RTMP)

RTMP			EQU  $01	 ; DDP protocol type code for RTMP

; RTMP header offsets

RTMPNet 		EQU  0	 ; Offset to network number [word]
RTMPIDLen		EQU  2	 ; Offset to ID length [byte]
RTMPID			EQU  3	 ; Offset to start of ID field

; RTMP packets are received at the well-known RTMP listening socket:

RTMPSkt 		EQU  1	 ; Number of the RTMP socket


;+ Datagram Delivery Protocol (DDP)

ddpHopCnt		EQU  0	 ; Hop count (only used in long header) [byte]
ddpLength		EQU  0	 ; Packet length (from this word onwards) [word]
ddpChecksum 	EQU  2	 ; Checksum [word]
ddpDstNet		EQU  4	 ; Destination network no. [word]
ddpSrcNet		EQU  6	 ; Network of origin [word]
ddpDstNode		EQU  8	 ; Destination node address [byte]
ddpSrcNode		EQU  9	 ; Node of origin [byte]
ddpDstSkt		EQU  10  ; Destination socket number [byte]
ddpSrcSkt	   EQU	 11  ; Source socket number [byte]
ddpType 		EQU  12  ; DDP type field [byte]

sDDPDstSkt		EQU  2	 ; Destination socket number (short header) [byte]
sDDPSrcSkt		EQU  3	 ; Source socket number (short header) [byte]
sDDPType		EQU  4	 ; DDP type field (short header) [byte]

DDPHSzLong		EQU  13  ; Size of extended DDP header
DDPHSzShort 	EQU  5	 ; Size of short DDP header

ShortDDP		EQU  $01	 ; LAP type code for DDP (short header)
LongDDP 		EQU  $02	 ; LAP type code for DDP (long header)

; DDP miscellaneous

ddpMaxWKS		EQU  $7F	 ; The highest valid well-known socket
ddpMaxData		EQU  586	 ; Maximum DDP data size
ddpLenMask		EQU  $03FF	 ; Mask for DDP length


;+ AppleBus Link Access Protocol (ABLAP)

lapDstAdr		EQU  0	 ; Destination node address [byte]
lapSrcAdr		EQU  1	 ; Source node address [byte]
lapType 		EQU  2	 ; LAP type field [byte]
lapHdSz 		EQU  3	 ; Size of LAP header

; zs returned by ReadPacket and ReadRest routines

OverrunErr		EQU  -1
CRCErr			EQU  -2
UnderrunErr 	EQU  -3
LengthErr		EQU  -4

; SCC interrupt priority

SCCLockout		EQU  $2600	 ; This value works on both Mac and Lisa


;+ MPP (control calls to NBP, DDP and ABLAP)

LookupReply 	EQU  242	 ; This command queued to ourself
WriteLAP		EQU  243	 ; Write out LAP packet
DetachPH		EQU  244	 ; Detach LAP protocol handler
AttachPH		EQU  245	 ; Attach LAP protocol handler
WriteDDP		EQU  246	 ; Write out DDP packet
CloseSkt		EQU  247	 ; Close DDP socket
OpenSkt 		EQU  248	 ; Open DDP socket
LoadNBP 		EQU  249	 ; Load NBP command-executing code
LastResident	EQU  249	 ; Last resident command
ConfirmName 	EQU  250	 ; Confirm name 		 |
LookupName		EQU  251	 ; Look up name on internet  |
RemoveName		EQU  252	 ; Remove name from Names Table  |_ Swapped
RegisterName	EQU  253	 ; Register name in Names Table  |	  In
KillNBP 		EQU  254	 ; Kill outstanding NBP request  |
UnloadNBP		EQU  255	 ; Unload NBP command code	 |

FirstMPP		EQU  242	 ; First MPP command
LastMPP 		EQU  255	 ; Last MPP command

; MPP queue element standard structure:  arguments passed in the CSParam area

Socket			EQU  $1C	 ; Offset to socket number (DDP) [byte]
CheckSumFlag	EQU  $1D	 ; Offset to checksum flag (DDP) [byte]
Listener		EQU  $1E	 ; Offset to socket listener (DDP) [word]
ArgBlkSz		EQU  $10	 ; Size of argument block to WriteDDP
WDSPointer		EQU  $1E	 ; Offset to WDS pointer (DDP & ABLAP) [word]

ProtType		EQU  $1C	 ; Offset to protocol type code (ABLAP) [byte]
Handler 		EQU  $1E	 ; Offset to protocol handler (ABLAP) [word]

Interval		EQU  $1C	 ; Retry interval (NBP) [byte]
Count			EQU  $1D	 ; Retry count (NBP) [byte]
EntityPtr		EQU  $1E	 ; Entity pointer (NBP)
NTQElPtr		EQU  $1E	 ; NT queue element ptr (NBP - Register)
ConfirmAddr 	EQU  $22	 ; Address to confirm at (NBP - Confirm)
NewSocket		EQU  $26	 ; Socket no. if different (NBP - Confirm) [byte]

VerifyFlag		EQU  $22	 ; Verify name flag (NBP - Register) [byte]

RetBuffPtr		EQU  $22	 ; Return buffer pointer (NBP - Lookup)
RetBuffSize 	EQU  $26	 ; Return buffer size (NBP - Lookup) [word]
MaxToGet		EQU  $28	 ; Max no. responses to get (NBP - Lookup) [word]
NumGotten		EQU  $2A	 ; Number actually gotten (NBP - Lookup) [word]

; Names Table Queue element - the MPP registered names (and associated sockets)

NTLink			EQU  0	 ; Link to next element
NTTuple 		EQU  4	 ; Start of tuple for replies
NTSocket		EQU  7	 ; Socket number of entity [byte]
NTEntity		EQU  9	 ; Start of entity name within tuple

; Well-known offsets within MPP local variables (as pointed to by AbusVars)

SysLAPAddr		EQU  0	 ; This node's LAP address
ToRHA			EQU  1	 ; Top of RHA
SysABridge		EQU  $19	 ; Node address of a bridge [byte]
SysNetNum		EQU  $1A	 ; This node's network number [word]
VSCCEnable		EQU  $1C	 ; SR value to re-enable SCC interrupts [word]
ATPVars 		EQU  $1E	 ; ATP variable pointer (high byte is flag)
AfterGlobals	EQU  $22	 ; After the globals

; MPP miscellaneous
RHASize 		EQU  $18	 ; Size of read header area
WDSEntrySz		EQU  6	 ; Size of a WDS entry



;+ AppleTalk Transaction Protocol (ATP)

ATP 			EQU  $3  ; ATP type code (in DDP header)

; ATP header

atpControl		EQU  0	 ; Control field [byte]
atpBitmap		EQU  1	 ; Bitmap (requests only) [byte]
atpRespNo		EQU  1	 ; Response number (responses only) [byte]
atpTransID		EQU  2	 ; Transaction ID [word]
atpUserData 	EQU  4	 ; Start of user data [long]
atpHdSz 		EQU  8	 ; Size of ATP header

; ATP control field

atpReqCode		EQU  $40	 ; Request code after masking
atpRspCode		EQU  $80	 ; Response code after masking
atpRelCode		EQU  $C0	 ; Release code after masking
atpXOBit		EQU  5	 ; Bit number of exactly-once bit
atpEOMBit		EQU  4	 ; Bit number of End-Of-Message bit
atpSTSBit		EQU  3	 ; Send Transmission Status bit no.
FlagMask		EQU  $3F	 ; Mask for just flags
ControlMask 	EQU  $F8	 ; Mask for good control bits

; ATP limits

atpMaxNum		EQU  8	 ; Max no. of responses per request
atpMaxData		EQU  $242	 ; Maximum data size in ATP packet

; ATP contol calls

RelRspCB		EQU  249	 ; Release RspCB	  | 		 |
CloseATPSkt 	EQU  250	 ; Close ATP socket   | 		 |
AddResponse 	EQU  251	 ; Add response code  | Require open skt |
SendResponse	EQU  252	 ; Send response code | 		 |
GetRequest		EQU  253	 ; Get request code   | 		 |
OpenATPSkt		EQU  254	 ; Open ATP socket
SendRequest 	EQU  255	 ; Send request code
RelTCB			EQU  256	 ; Release TCB

FirstATP		EQU  249	 ; First ATP command
LastATP 		EQU  256	 ; Last ATP command
FirstNoSkt		EQU  254	 ; First not requiring an open socket

; ATP queue element standard structure:  arguments passed in the CSParam area

atpSocket		EQU  $1C	 ; Socket number is first parameter [byte]
atpFlags		EQU  $1D	 ; Flag [byte]
AddrBlock		EQU  $1E	 ; Start of address block
ReqLength		EQU  $22	 ; Size of request buffer [word]
ReqPointer		EQU  $24	 ; Pointer to request buffer or data
BDSPointer		EQU  $28	 ; Pointer to Buffer Data Structure (BDS)
GUArea			EQU  $2C	 ; Start of general-use area
UserData		EQU  $12	 ; User bytes

; ATP bits

SendCHK 		EQU  0	 ; Bit no. of send-checksum bit in flags
tidValid		EQU  1	 ; Bit set when TID valid in SendRequest

; SendRequest call interface

NumOfBuffs		EQU  $2C	 ; No. of response buffers passed in BDS [byte]
TimeoutVal		EQU  $2D	 ; Timeout length in seconds [byte]
NumOfResps		EQU  $2E	 ; Number of responses received [byte]
RetryCount		EQU  $2F	 ; Maximum number of retries [byte]

ReqTID			EQU  $16	 ; Request's TID returned here (for RelTCB)
CurrBitmap		EQU  $1C	 ; Bitmap of responses not yet received [byte]

; GetRequest call interface

Bitmap			EQU  $2C	 ; Offset where bitmap is returned [byte]
TransID 		EQU  $2E	 ; Transaction ID returned here [word]

; SendResponse call interface

BDSSize 		EQU  $2D

; AddResponse call interface

RspNum			EQU  $2C	 ; No. of this response with transaction [byte]

; ATP general

MaxReqs 		EQU  6	 ; Maximum number of concurrent requests
MaxRsps 		EQU  8	 ; Max number of concurrent XO responses
MaxATPSkts		EQU  6	 ; Max number of concurrent responding-sockets
ReleaseTime 	EQU  30  ; Release timer value in seconds

; ATP Buffer Descriptor Structure (BDS)

BDSBuffSz		EQU  0	 ; Send: data length	 Receive: buffer length
BDSBuffAdr		EQU  2	 ; Send: data address	 Receive: buffer address
BDSDataSz		EQU  6	 ; Send: used internally Receive: data length
BDSUserData 	EQU  8	 ; Send: 4 user bytes	 Receive: 4 user bytes
BDSEntrySz		EQU  12  ; Size of a BDS entry


