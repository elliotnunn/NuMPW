; File ScriptEqu.a
; -----------------------------------------------------------------------------
; Script Manager equates file.
;
; version 2.0a3
;
; Written by Ken Krugler and Joe Ternasky	July 12, 1986
;
; This file contains all equates for the script environment, shared
; equates for the script interface systems, equates that are special for
; the Roman Interface System, and all equates for the script interface
; system package.
;
; Copyright Apple Computer, Inc. 1986
; All Rights Reserved
;
; History:
;
; 11 Jul 86 KWK	New today.
; 12 Jul 86 KWK	Added new equates from Joe's SISEqu.a file, global ptr
;		table, SISFullAscii/SISEnabled flags, changed macros back
;		to Pack8 calls.
; 13 Jul 86 KWK	Mega-changes for standard routine trap-out, Roman script
;		init, et. al.
; 13 Jul 86 JDT Reorganized sis and script records, constants.
; 14 Jul 86 JDT Region names no longer appear in the region bundle.  The
;		name of the region is now the region bundle resource
;		name, and the region code is the resource id number.
; 21 Jul 86 JDT Added language field to region bundles and script entry.
; 22 Jul 86 JDT Split the Blocker into four separate routines.
;  1 Aug 86 JDT	Replaced the FindBlock and NextBlock routines with the
;		DrawJust and MeasureJust routines.
;  5 Aug 86 JDT	Major reorganization of sis and script structures.
; 19 Aug 86 KWK	Minor equate changes for new trap architecture.
; 21 Aug 86 JDT	Modified for Script Manager.
; 23 Aug 86 KWK	Removed ScriptVersion equate, added Mark's complete set of
;		script equates (yes, that's right, smMongolian lives).
;		Added 'itl2' equate (Sorting hooks).
; 28 Aug 86 JDT	Moved KeyTrans variables into Script Manager core.
;  3 Sep 86 JDT Wet'n'wild reorganization.  Region bundles eliminated.
;  5 Sep 86 JDT Wacky force flags added to script manager globals and supported
;		by FontScript and IntlScript.
;		IntlScript removed and trap selectors reorganized.
;  9 Oct 86 JDT	Added dead key state to the script manager globals.
;		Removed smgrCore and smgrOldCore constants.
;		Use Ken's macro or else.
; 16 Oct 86 KWK	It's ugly...added 3 vectors after smgrPrintAction for backwards
;		compatibilty with KanjiTalk 1.0 applications and system file.
; 17 Oct 86 jdt	Bumped high byte of version number for SMgr globals change.
; 25 Oct 86 jdt	Yet another ugly patch for KanjiTalk.  We force the KanjiTalk
;		system font ID number to be in the Japanese script range, so
;		the version number has changed again.
; 16 Nov 86 KWK	Removed GMT, latitude and longitude vars from SmgrRecord.
;		Re-adjusted size of core back to version 1.0 for AIS.
;		Fixed some script range equates.
;		Added the _ParseTable macro, selector
; 20 Nov 86 jdt	New version number for Universal system file changes.
; 21 Nov 86 jdt	Moved the Roman equates here.
; 21 Nov 86 MED	Added the GetThePort macro for MPW compatability.
; 25 Nov 86 jdt Added compatability flags for MS, MPW, AIS 1.0, and old apps.
;		Moved itl2 routine equates here from Pack6Equ.a.
;  5 Dec 86 jdt	Added ParseTable macro to ScriptUtil list.
;		Removed the KeyTrans trap macro.
;		Added CharByte byte types.
; 22 Dec 86 jdt	Added the smBidirect variable to the Script Manager gloabls.
;		Changed compatabilitiy flag names.
;		Added last environment and script verb constants.
;		Fixed new selector for KeyScript.
; 23 Dec 86 med	Added private equates flag.
; 23 Dec 86 jdt	Fixed macros for Script Manager routines.
;		Rearranged constants into public and private sets.
;  2 Jan 87 jdt	New version number for release.
;  5 Jan 87 jdt	Changed hook names for itl2.  We now have the exit hook.
;		Added result to Pack6 sorting stack frame.
; 13 Jan 87 jdt	Replaced smAppScript verb and global with smLastScript.
; 19 Jan 87 jdt	Modified getSMgrCore macro to use expaned low memory block.
; <1/28/87MED>	Added CheckAReg for a little type checking in macros
;		Fixed use of wholeSmgr
;		Added and used smgrEMOffset
; -----------------------------------------------------------------------------

; -----------------------------------------------------------------------------
; Constants for the Script Manager trap call, _ScriptUtil.
; -----------------------------------------------------------------------------

; Script Interface System numbers.

smRoman		equ	0			; Font script is Roman.

smJapanese	equ	1			; Font script is Japanese.
smChinese	equ	2			; Font script is Chinese.
smKorean	equ	3			; Font script is Korean.

smArabic	equ	4			; Font script is Arabic.
smHebrew	equ	5			; Font script is Hebrew.
smGreek		equ	6			; Font script is Greek.
smRussian	equ	7			; Font script is Russian.

smReserved1	equ	8			; Font script is Reserved1.

smDevanagari	equ	9			; Font script is Devanagari.
smGurmukhi	equ	10			; Font script is Gurmukhi.
smGujarati	equ	11			; Font script is Gujarati.
smOriya		equ	12			; Font script is Oriya.
smBengali	equ	13			; Font script is Bengali.
smTamil		equ	14			; Font script is Tamil.
smTelugu	equ	15			; Font script is Telugu.
smKannada	equ	16			; Font script is Kannada.
smMalayalam	equ	17			; Font script is Malayalam.
smSinhalese	equ	18			; Font script is Sinhalese.

smBurmese	equ	19			; Font script is Burmese.
smKhmer		equ	20			; Font script is Khmer.
smThai		equ	21			; Font script is Thai.
smLaotian	equ	22			; Font script is Laotian.

smGeorgian	equ	23			; Font script is Georgian.
smArmenian	equ	24			; Font script is Armenian.

smMaldivian	equ	25			; Font script is Maldivian.
smTibetan	equ	26			; Font script is Tibetan.
smMongolian	equ	27			; Font script is Mongolian.
smAmharic	equ	28			; Font script is Amharic.

smSlavic	equ	29			; Font script is Slavic.
smVietnamese	equ	30			; Font script is Vietnamese.
smSindhi	equ	31			; Font script is Sindhi.

smReserved2	equ	32			; Font script is Reserved2.

; Language Codes
langEnglish	equ	0
langFrench	equ	1
langGerman	equ	2
langItalian	equ	3
langDutch	equ	4
langSwedish	equ	5
langSpanish	equ	6
langDanish	equ	7
langPortugese 	equ	8
langNorwegian	equ	9
langHebrew	equ	10
langJapanese	equ	11
langArabic	equ	12
langFinish	equ	13
langGreek	equ	14
langIcelandic	equ	15
langMalta	equ	16
langTurkish	equ	17
langYugoslavian	equ	18
langChinese	equ	19
langUrdu	equ	20
langHindi	equ	21
langThai	equ	22


; CharByte byte types.

smSingleByte	equ	 0
smFirstByte	equ	-1
smLastByte	equ	 1
smMiddleByte	equ	 2

; CharType character types.

smCharPunct	equ	0
smCharAscii	equ	1
smCharEuro	equ	7

; CharType punctuation types.

smPunctNormal	equ	$0000
smPunctNumber	equ	$0100
smPunctSymbol	equ	$0200

; CharType case modifers.

smCharLower	equ	$0000
smCharUpper	equ	$4000

; CharType character size modifiers (1 or multiple bytes).

smChar1byte	equ	$0000
smChar2byte	equ	$8000

; Char2Pixel directions.
	
smLeftCaret	equ	 0			; Place caret for left block.
smRightCaret	equ	-1			; Place caret for right block.
smHilite	equ	 1			; Direction is TESysJust.
	
; Transliterate target types.

smTransAscii	equ	0
smTransNative	equ	1

; Transliterate target modifiers.

smTransLower	equ	$4000
smTransUpper	equ	$8000

; Transliterate source masks.

smMaskAscii	equ	$0001			; 2^smTransAscii
smMaskNative	equ	$0002			; 2^smTransNative

; Result values from GetEnvirons, SetEnvirons, GetScript and SetScript calls.

smBadVerb	equ	-1			; Bad verb passed to a routine.
smBadScript	equ	-2			; Bad script code passed to a routine.

; GetEnvirons and SetEnvirons verbs.

smVersion	equ	 0			; Environment version number.
smMunged	equ	 2			; Globals change count.
smEnabled	equ	 4			; Environment enabled flag.
smBidirect	equ	 6			; One bidirectional script.

smFontForce	equ	 8			; Force font flag.
smIntlForce	equ	10			; Force intl flag.
smForced	equ	12			; forced to system script.
smDefault	equ	14			; defaulted to Roman script.

smPrint		equ	16			; Printer action routine.

smSysScript	equ	18			; System script.
smLastScript	equ	20			; Last keyboard script.
smKeyScript	equ	22			; Keyboard script.

smSysRef	equ	24			; System folder refNum.
smKeyCache	equ	26			; Keyboard table cache pointer.
smKeySwap	equ	28			; Swapping table pointer.

smLastEVerb	equ	smKeySwap		; Last environment verb.

; GetScript and SetScript verbs.

smScriptVersion	equ	 0			; Script software version.
smScriptMunged	equ	 2			; Script entry changed count.
smScriptEnabled	equ	 4			; Script enabled flag.
smScriptRight	equ	 6			; Right to left flag.
smScriptJust	equ	 8			; Justification flag.
smScriptRedraw	equ	10			; Word redraw flag.

smScriptSysFond	equ	12			; Preferred system font.
smScriptAppFond	equ	14			; Preferred Application font.

smScriptBundle	equ	16			; Beginning of dictionary verbs.
smScriptNumber	equ	16			; Script itl0 id, from dictionary.
smScriptDate	equ	18			; Script itl1 id, from dictionary.
smScriptSort	equ	20			; Script itl2 id, from dictionary.
smScriptRsvd1	equ	22			; reserved.
smScriptRsvd2	equ	24			; reserved.
smScriptRsvd3	equ	26			; reserved.
smScriptRsvd4	equ	28			; reserved.
smScriptRsvd5	equ	30			; reserved.
smScriptKeys	equ	32			; Script KEYC id.
smScriptIcon	equ	34			; Script SICN id.

smScriptPrint	equ	36			; Script printer action routine.
smScriptTrap	equ	38			; Trap entry pointer.

smScriptCreator	equ	40			; Script file creator.
smScriptFile	equ	42			; Script file name.
smScriptName	equ	44			; Script name.

smLastSVerb	equ	smScriptName		; Last script verb.

; -----------------------------------------------------------------------------
; Macros for the Script Manager trap call, _ScriptUtil.
; -----------------------------------------------------------------------------

_ScriptUtil	opword	$A8B5

; Trap routine selectors.

smFontScript	equ	 0
smIntlScript	equ	 2
smKybdScript	equ	 4
smFont2Script	equ	 6
smGetEnvirons	equ	 8
smSetEnvirons	equ	10
smGetScript	equ	12
smSetScript	equ	14
smCharByte	equ	16
smCharType	equ	18
smPixel2Char	equ	20
smChar2Pixel	equ	22
smTranslit	equ	24
smFindWord	equ	26
smHiliteText	equ	28
smDrawJust	equ	30
smMeasureJust	equ	32
smParseTable	equ	34

; Trap routine macros.

		macro
		_FontScript
		move.l	#(1<<31)+($0200<<16)+smFontScript,-(sp)
		_ScriptUtil
		endm

		macro
		_IntlScript
		move.l	#(1<<31)+($0200<<16)+smIntlScript,-(sp)
		_ScriptUtil
		endm

		macro
		_KeyScript
		move.l	#(1<<31)+($0002<<16)+smKybdScript,-(sp)
		_ScriptUtil
		endm

		macro
		_Font2Script
		move.l	#(1<<31)+($0202<<16)+smFont2Script,-(sp)
		_ScriptUtil
		endm

		macro
		_GetEnvirons
		move.l	#(1<<31)+($0402<<16)+smGetEnvirons,-(sp)
		_ScriptUtil
		endm

		macro
		_SetEnvirons
		move.l	#(1<<31)+($0206<<16)+smSetEnvirons,-(sp)
		_ScriptUtil
		endm

		macro
		_GetScript
		move.l	#(1<<31)+($0404<<16)+smGetScript,-(sp)
		_ScriptUtil
		endm

		macro
		_SetScript
		move.l	#(1<<31)+($0208<<16)+smSetScript,-(sp)
		_ScriptUtil
		endm

		macro
		_CharByte
		move.l	#(1<<31)+($0206<<16)+smCharByte,-(sp)
		_ScriptUtil
		endm

		macro
		_CharType
		move.l	#(1<<31)+($0206<<16)+smCharType,-(sp)
		_ScriptUtil
		endm

		macro
		_Pixel2Char
		move.l	#(1<<31)+($020E<<16)+smPixel2Char,-(sp)
		_ScriptUtil
		endm

		macro
		_Char2Pixel
		move.l	#(1<<31)+($020C<<16)+smChar2Pixel,-(sp)
		_ScriptUtil
		endm

		macro
		_Transliterate
		move.l	#(1<<31)+($020E<<16)+smTranslit,-(sp)
		_ScriptUtil
		endm

		macro
		_FindWord
		move.l	#(1<<31)+($0012<<16)+smFindWord,-(sp)
		_ScriptUtil
		endm

		macro
		_HiliteText
		move.l	#(1<<31)+($000E<<16)+smHiliteText,-(sp)
		_ScriptUtil
		endm

		macro
		_DrawJust
		move.l	#(1<<31)+($0008<<16)+smDrawJust,-(sp)
		_ScriptUtil
		endm

		macro
		_MeasureJust
		move.l	#(1<<31)+($000C<<16)+smMeasureJust,-(sp)
		_ScriptUtil
		endm

		macro
		_ParseTable
		move.l	#(1<<31)+($0204<<16)+smParseTable,-(sp)
		_ScriptUtil
		endm
	

	IF PrNonPortable THEN

; -----------------------------------------------------------------------------
; Private declarations for the Script Manager and Script Interface Systems.
; -----------------------------------------------------------------------------

; Note that the version number is divided into two bytes:  The high byte is
; bumped when the changes make the next version incompatible with previous
; versions.  If compatability is maintained, the low byte is bumped.

smgrVers	equ	$0153		; current version number.
smgrEMOffset	equ	6		; script manager offset in expandMem

; Flags for various tweaks, which should go away as more applications and
; script interface systems understand how the Script Manager works.

msTweaks	equ	0			; MicroSoft Excel compatability tweaks.
mpwTweaks	equ	1			; MPW compatability tweaks.
appTweaks	equ	1			; old application compatability tweaks.
aisTweaks	equ	1			; AIS 1.0 compatability tweaks.
bufTweaks	equ	0			; controls sysheap vs bufptr storage

; Record declaration for the environment globals.
; Note:  The printer action routine must be at offset #22 for compatability
; with KanjiTalk 1.0.

smgrCount	equ	65			; number of script entries.

smgrRecord	record	0
smgrVersion	ds.w	1			; script version number.
smgrMunged	ds.w	1			; munge count.
smgrEnabled	ds.b	1			; enabled flag.
smgrBidirect	ds.b	1			; one bidirect script.
smgrFontForce	ds.b	1			; force font flag.
smgrIntlForce	ds.b	1			; force intl flag.
smgrForced	ds.b	1			; forced to system script.
smgrDefault	ds.b	1			; defaulted to Roman script.

		ds.l	3			; reserved

smgrPrint	ds.l	1			; printer action dispatcher.

smgrIntlMode	ds.l	1			; IntlMode vector.
smgrCharByte	ds.l	1			; CharByte vector.
smgrCharType	ds.l	1			; CharType vector.

smgrSysScript	ds.w	1			; preferred system script.
smgrLastScript	ds.w	1			; last keyboard script.
smgrKeyScript	ds.w	1			; keyboard script.

smgrRect	ds.w	4			; toggling rectangle.
smgrSysRef	ds.w	1			; system file volRefNum.
smgrKeyCache	ds.l	1			; keyboard table pointer.
smgrKeySwap	ds.l	1			; swapping table pointer.
smgrDeadState	ds.l	1			; keyboard dead key state.

smgrCSisPtr	ds.l	1			; contextual SIS globals ptr
smgrCSisFlags	ds.l	1			; flag bits for contextual SIS

		ds.l	10			; reserved.

smgrEntry	ds.l	smgrCount		; script global entries.

smgrSize	equ	*			; size of script manager core.
		endr

; paranoid type checking

		macro
		CheckAReg &AReg
		if	&UpCase(&SubStr(&AReg,1,1))<>'A' then
		aerror 'Bad Reg in Macro'
		endif
		endm

; Script Manager environment macro.  Load smgrCore from expanded globals
; table.

		macro
		GetSmgrCore &reg
		CheckAReg &reg			; is it an A reg?
		move.l	expandMem,&reg		; load expanded memory pointer.
		move.l	smgrEMOffset(&reg),&reg	; load smgrCore pointer.
		endm

; Current GrafPort macro.  Load the current GrafPort pointer into the
; indicated register.  This has a special tweak for MPW to work properly.

mpwPtr		equ	$316			; MPW global pointer.

		macro
		GetThePort &reg
		CheckAReg &reg			; is it an A reg?
		move.l	grafGlobals(a5),&reg	; load grafGlobals.
		move.l	thePort(&reg),&reg	; load thePort.
	
		if mpwTweaks then
		tst.l	mpwPtr			; MPW running?
		ble.s	@0			; no -> skip this.
		move.l	WMgrPort,&reg		; best guess for MPW.
		endif
@0
		endm

; Record declaration for the script globals.  This first set is always the
; same for every script.  Local variables that are specific to each script
; follow the fields described here in the globals.

scriptRecord	record	0
scriptVersion	ds.w	1			; script version number.
scriptMunged	ds.w	1			; munge count.
scriptEnabled	ds.b	1			; script enabled flag.
scriptRight	ds.b	1			; right to left flag.
scriptJust	ds.b	1			; justification flag.
scriptRedraw	ds.b	1			; word redraw flag.
		
scriptSysFond	ds.w	1			; preferred system font.
scriptAppFond	ds.w	1			; preferred application font.

scriptBundle	equ	*			; script dictionary.
scriptNumber	ds.w	1			; ITL0 id number.
scriptDate	ds.w	1			; ITL1 id number.
scriptSort	ds.w	1			; ITL2 id number.
		ds.w	5			; reserved.
scriptKeys	ds.w	1			; KCHR id number.
scriptIcon	ds.w	1			; SICN id number.

scriptPrint	ds.l	1			; printer action vector.
scriptTrap	ds.l	1			; ScriptUtil trap vector.
		
scriptCreator	ds.l	1			; sis creator signature.
scriptFile	ds.l	1			; sis file name.
scriptName	ds.l	1			; sis name.

scriptReserved	ds.l	16			; reserved.

scriptSize	equ	*			; size of script entry.
		endr

; Roman script constants.

romanVers	equ	1			; version number.
romanSysFond	equ	0			; system font id number.
romanAppFond	equ	3			; application font id number.
romanCoreSize	equ	scriptRecord.scriptSize	; size of Roman globals.

; Record declaration for international configuration resource (type itlc).

itlcRecord	record	0
itlcSystem	ds.w	1			; default system script.
itlcKeyCache	ds.w	1			; keyboard table cache size.
itlcFontForce	ds.b	1			; default font force flag.
itlcIntlForce	ds.b	1			; default intl force flag.
itlcSize	equ	*			; size of script itlc.
		endr

; Record declaration for international bundle resource (type itlb).

itlbRecord	record	0
itlbNumber	ds.w	1			; ITL0 id number.
itlbDate	ds.w	1			; ITL1 id number.
itlbSort	ds.w	1			; ITL2 id number.
itlbLang	ds.w	1			; language for bundle
		ds.w	1			; reserved.
		ds.w	1			; reserved.
		ds.w	1			; reserved.
		ds.w	1			; reserved.
itlbKeys	ds.w	1			; KCHR id number.
itlbIcon	ds.w	1			; SICN id number.
itlbSize	equ	*			; size of bundle.
		endr

; itl2 routine vector offsets.

InitHook	equ	0
FetchHook	equ	2
VernierHook	equ	4
ProjectHook	equ	6
RsvdHook	equ	8
ExitHook	equ	10

; String data structure for itl2 stack frames.

IUStrData	record	0
CurChar		ds.w	1			; current character.
MapChar 	ds.w	1			; projected character.
DecChar 	ds.w	1			; decision char for weak equality.
BufChar 	ds.b	1			; buffer for expansion.
JustAfter	ds.b	1			; boolean for AE vs ligature-AE.
IgnChar		ds.b	1			; flag: ignore char.
NoFetch		ds.b	1			; flag: no fetch of next.
StrCnt		ds.w	1			; length word.
StrPtr		ds.l	1			; current ptr to string.
		endR

; Stack frame for itl2 routines.

IUSortFrame	record	{oldA6},decrement
result		ds.w	1
AStrText	ds.l	1
BStrText	ds.l	1
AStrLen		ds.w	1
BStrLen		ds.w	1
return		ds.l	1
oldA6		ds.l	1
AInfo		ds	IUStrData
BInfo		ds	IUStrData
WantMag 	ds.b	1			; 1-MagStrig 0-MagIdString.
WeakEq		ds.b	1			; Signals at most weak equality.
MSLock		ds.b	1			; high byte of master ptr.
WeakMag 	ds.b	1			; -1 weak compare, 1 strong compare.
SupStorage	ds.b	18			; extra storage.
LkSize		equ	*			; frame size.
ParamBytes	equ	AStrText-Return
		endR
		
; Script Manager font equates.

smFondStart	equ	$4000			; start from 16K.
smFondEnd	equ	$C000			; past end of range at 48K.

		ENDIF	;end exclusion of private information
